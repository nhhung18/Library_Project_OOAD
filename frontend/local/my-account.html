<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√†i Kho·∫£n C·ªßa T√¥i - Th∆∞ vi·ªán HAB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .account-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        .account-sidebar {
            background: #f9f9f9;
            padding: 1.5rem;
            border-radius: 0.5rem;
            height: fit-content;
        }
        
        .account-sidebar a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: var(--black);
            border-radius: 0.3rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .account-sidebar a:hover,
        .account-sidebar a.active {
            background: var(--green);
            color: white;
        }
        
        .account-sidebar a i {
            width: 20px;
            text-align: center;
        }
        
        .account-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: var(--box-shadow);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .profile-card {
            background: #f9f9f9;
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
        }
        
        .profile-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .info-item {
            padding: 1rem;
            background: white;
            border-radius: 0.3rem;
            border-left: 4px solid var(--green);
        }
        
        .info-item label {
            font-size: 0.9rem;
            color: #666;
            display: block;
            margin-bottom: 0.3rem;
        }
        
        .info-item value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--black);
        }
        
        .borrow-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .borrow-table th {
            background: var(--green);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }
        
        .borrow-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        
        .borrow-table tr:hover {
            background: #f9f9f9;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
        }
        
        .status-pending { background: #f39c12; }
        .status-approved { background: #3498db; }
        .status-returned { background: #27ae60; }
        .status-overdue { background: #e74c3c; }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            color: #ddd;
            display: block;
            margin-bottom: 1rem;
        }
        
        @media (max-width: 768px) {
            .account-container {
                grid-template-columns: 1fr;
            }
            
            .account-sidebar {
                display: flex;
                gap: 0.5rem;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>

<header class="header">
    <div class="header-1">
        <a href="index.html" class="logo"> Th∆∞ vi·ªán HAB </a>
        <form action="" class="search-form">
            <input type="search" placeholder="t√¨m ki·∫øm s√°ch..." id="search-box">
            <label for="search-box" class="fas fa-search"></label>
        </form>
        <div class="icons">
            <div id="search-btn" class="fas fa-search"></div>
            <a href="#" class="fas fa-heart"></a>
            <a href="#" class="fas fa-shopping-cart" id="cart-btn">
                <span id="cart-count" class="cart-badge">0</span>
            </a>
            <div id="login-btn" class="fas fa-user"></div>
        </div>
    </div>
    <div class="header-2">
        <nav class="navbar">
            <a href="index.html">Trang ch·ªß</a>
            <a href="books.html">S√°ch</a>
            <a href="index.html#reviews">ƒê√°nh gi√°</a>
            <a href="#blogs">V·ªÅ ch√∫ng t√¥i</a>
        </nav>
    </div>
</header>

<nav class="bottom-navbar">
    <a href="index.html" class="fas fa-home"></a>
    <a href="books.html" class="fas fa-list"></a>
</nav>

<section style="padding: 0; background: #fff;">
    <div class="account-container">
        <div class="account-sidebar">
            <a class="menu-item active" onclick="switchSection('profile', this)">
                <i class="fas fa-user"></i> H·ªì S∆°
            </a>
            <a class="menu-item" onclick="switchSection('borrowing', this)">
                <i class="fas fa-book"></i> S√°ch ƒêang M∆∞·ª£n
            </a>
            <a class="menu-item" onclick="switchSection('history', this)">
                <i class="fas fa-history"></i> L·ªãch S·ª≠
            </a>
            <a class="menu-item" onclick="switchSection('membership', this)">
                <i class="fas fa-id-card"></i> ƒêƒÉng K√Ω Th·∫ª
            </a>
            <a class="menu-item" onclick="switchSection('favorites', this)">
                <i class="fas fa-heart"></i> Y√™u Th√≠ch
            </a>
            <a class="menu-item" onclick="switchSection('password', this)">
                <i class="fas fa-lock"></i> ƒê·ªïi M·∫≠t Kh·∫©u
            </a>
            <a class="menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t
            </a>
        </div>

        <div class="account-content">
            <!-- Profile Section -->
            <div id="profile" class="section active">
                <h2>H·ªì S∆° C√° Nh√¢n</h2>
                <div class="profile-card" id="profileCard">
                    <!-- S·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                </div>
            </div>

            <!-- Borrowing Section -->
            <div id="borrowing" class="section">
                <h2>S√°ch ƒêang M∆∞·ª£n</h2>
                <table class="borrow-table" id="borrowingTable">
                    <thead>
                        <tr>
                            <th>T√™n S√°ch</th>
                            <th>Ng√†y M∆∞·ª£n</th>
                            <th>H·∫°n Tr·∫£</th>
                            <th>T√¨nh Tr·∫°ng</th>
                            <th>H√†nh ƒê·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="borrowingBody">
                    </tbody>
                </table>
                <div id="borrowingEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-inbox"></i>
                    <p>B·∫°n ch∆∞a m∆∞·ª£n s√°ch n√†o</p>
                </div>
            </div>

            <!-- History Section -->
            <div id="history" class="section">
                <h2>L·ªãch S·ª≠ M∆∞·ª£n</h2>
                <table class="borrow-table" id="historyTable">
                    <thead>
                        <tr>
                            <th>T√™n S√°ch</th>
                            <th>Ng√†y M∆∞·ª£n</th>
                            <th>Ng√†y Tr·∫£</th>
                            <th>Tr·∫°ng Th√°i</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody">
                    </tbody>
                </table>
                <div id="historyEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-history"></i>
                    <p>Ch∆∞a c√≥ l·ªãch s·ª≠ m∆∞·ª£n</p>
                </div>
            </div>

            <!-- Membership Tier Section -->
            <div id="membership" class="section">
                <h2>ƒêƒÉng K√Ω Th·∫ª M∆∞·ª£n</h2>
                <div id="membershipTierCard" style="background:#f9f9f9; padding:2rem; border-radius:0.5rem; margin-bottom:2rem;">
                    <div style="text-align:center; margin-bottom:2rem;">
                        <h3 id="currentTierName" style="color:var(--green); font-size:2rem; margin:0;">ƒêang T·∫£i...</h3>
                    </div>
                    <div style="background:white; padding:2rem; border-radius:0.5rem; border:2px solid #27ae60; text-align:center; max-width:500px; margin:0 auto;">
                        <h4 style="color:#333; margin:0 0 1rem 0; font-size:1.3rem;">üìñ G√≥i Ti√™u Chu·∫©n</h4>
                        <div style="background:#f5f5f5; padding:1.5rem; border-radius:0.3rem; margin-bottom:1rem;">
                            <p style="margin:0.7rem 0; font-size:0.95rem;">‚úì M∆∞∆°n kh√¥ng gi·ªõi h·∫°n</p>
                            <p style="margin:0.7rem 0; font-size:0.95rem;">‚úì H·∫°n m∆∞·ª£n: 30 ng√†y</p>
                            <p style="margin:0.7rem 0; font-size:0.95rem;">‚úì Gia h·∫°n: 2 l·∫ßn</p>
                        </div>
                        <div style="background:#fff3e0; padding:1rem; border-radius:0.3rem; margin-bottom:1.5rem;">
                            <p style="margin:0; font-size:1.3rem; color:#e74c3c; font-weight:bold;">üí∞ 50,000‚Ç´/th√°ng</p>
                        </div>
                        <button onclick="registerTier('bronze')" style="width:100%; padding:0.8rem 1.5rem; background:#27ae60; color:white; border:none; border-radius:0.3rem; cursor:pointer; font-size:1rem; font-weight:bold; transition:all 0.2s;" id="tierBronzeBtn">ƒêƒÉng K√Ω</button>
                    </div>
                    <div id="currentMembershipInfo" style="background:white; padding:1.5rem; border-radius:0.5rem; border-left:4px solid var(--green); display:none; margin-top:2rem;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <p style="margin:0; color:#666;">B·∫°n hi·ªán ƒëang s·ª≠ d·ª•ng:</p>
                                <p id="currentMembershipText" style="margin:0.5rem 0 0 0; font-size:1.2rem; font-weight:bold; color:var(--green);"></p>
                            </div>
                            <button id="cancelTierBtn" onclick="cancelTier()" style="padding:0.7rem 1.5rem; background:#e74c3c; color:white; border:none; border-radius:0.3rem; cursor:pointer; font-weight:bold; display:none;">‚ùå Hu·ª∑ G√≥i</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="favorites" class="section">
                <h2>S√°ch Y√™u Th√≠ch</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;" id="favoritesGrid">
                </div>
                <div id="favoritesEmpty" class="empty-state" style="display:none;">
                    <i class="fas fa-heart"></i>
                    <p>B·∫°n ch∆∞a th√™m s√°ch y√™u th√≠ch n√†o</p>
                </div>
            </div>

            <!-- Password Section -->
            <div id="password" class="section">
                <h2>ƒê·ªïi M·∫≠t Kh·∫©u</h2>
                <form onsubmit="changePassword(event)" style="max-width: 400px;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M·∫≠t kh·∫©u c≈©</label>
                        <input type="password" id="oldPassword" required style="width:100%; padding:0.8rem; border:1px solid #ccc; border-radius:0.3rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">M·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="newPassword" required style="width:100%; padding:0.8rem; border:1px solid #ccc; border-radius:0.3rem;">
                    </div>
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                        <input type="password" id="confirmPassword" required style="width:100%; padding:0.8rem; border:1px solid #ccc; border-radius:0.3rem;">
                    </div>
                    <button type="submit" class="btn">C·∫≠p Nh·∫≠t M·∫≠t Kh·∫©u</button>
                </form>
            </div>
        </div>
    </div>
</section>

<section class="footer">
    <div class="box-container">
        <div class="box">
            <img src="image/logo_HAB.png" alt="Logo HAB" class="footer-logo">
        </div>
        <div class="box">
            <h3>quick links</h3>
            <a href="index.html"> <i class="fas fa-arrow-right"></i> home </a>
            <a href="books.html"> <i class="fas fa-arrow-right"></i> s√°ch </a>
        </div>
    </div>
    <div class="credit"> created by <span>HungNguyen</span> | all rights reserved! </div>
</section>

<script src="js/script.js"></script>
<script>
// Check if user is logged in
document.addEventListener('DOMContentLoaded', function() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) {
        alert('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc');
        window.location.href = 'index.html';
        return;
    }
    
    loadProfile();
    loadBorrowingList();
    loadFavorites();
    
    // Ki·ªÉm tra URL parameter ƒë·ªÉ load section c·ª• th·ªÉ
    const params = new URLSearchParams(window.location.search);
    const section = params.get('section');
    if (section) {
        const menuItem = document.querySelector(`.menu-item[onclick="switchSection('${section}', this)"]`);
        if (menuItem) {
            menuItem.click();
        }
    }
});

function loadProfile() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    if (!currentUser) return;
    
    const rankMap = {
        'customer': 'Kh√°ch h√†ng',
        'librarian': 'Th·ªß th∆∞',
        'admin': 'Admin'
    };
    
    const borrowHistory = JSON.parse(localStorage.getItem('cart')) || [];
    const totalBorrowed = borrowHistory.length;
    const currentlyBorrowing = borrowHistory.filter(b => b.status !== 'returned').length;
    
    const tierStatus = currentUser.status === 'user' ? '‚úì ƒê√£ ƒêƒÉng K√Ω' : '‚ùå Ch∆∞a ƒêƒÉng K√Ω';
    
    document.getElementById('profileCard').innerHTML = `
        <div class="profile-info">
            <div class="info-item">
                <label>T√™n</label>
                <value>${currentUser.name}</value>
            </div>
            <div class="info-item">
                <label>Email</label>
                <value>${currentUser.email}</value>
            </div>
            <div class="info-item">
                <label>Lo·∫°i T√†i Kho·∫£n</label>
                <value>${rankMap[currentUser.role] || 'Kh√°ch h√†ng'}</value>
            </div>
            <div class="info-item">
                <label>Tr·∫°ng Th√°i Th·∫ª M∆∞·ª£n</label>
                <value style="color: ${currentUser.status === 'user' ? '#27ae60' : '#e74c3c'};">${tierStatus}</value>
            </div>
            <div class="info-item">
                <label>T·ªïng S√°ch ƒê√£ M∆∞·ª£n</label>
                <value>${totalBorrowed}</value>
            </div>
            <div class="info-item">
                <label>ƒêang M∆∞·ª£n</label>
                <value style="color: ${currentlyBorrowing > 0 ? '#f39c12' : '#27ae60'};">${currentlyBorrowing}</value>
            </div>
            <div class="info-item">
                <label>Ng√†y Tham Gia</label>
                <value>${new Date().toLocaleDateString('vi-VN')}</value>
            </div>
        </div>
    `;
}

function loadBorrowingList() {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const borrowing = cart.filter(item => item.status !== 'returned');
    const tbody = document.getElementById('borrowingBody');
    const empty = document.getElementById('borrowingEmpty');
    
    if (borrowing.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
    } else {
        tbody.innerHTML = borrowing.map((item, idx) => {
            const today = new Date();
            const dueDate = new Date(item.dueDate);
            const daysLeft = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            const isOverdue = daysLeft < 0;
            const statusClass = item.status === 'pending' ? 'status-pending' : 
                               item.status === 'approved' ? 'status-approved' : 
                               isOverdue ? 'status-overdue' : 'status-approved';
            const statusText = isOverdue ? '‚ö†Ô∏è QU√Å H·∫†N' :
                              daysLeft <= 3 ? 'üîî S·∫ÆP H·∫æT H·∫†N' :
                              item.status === 'pending' ? 'Ch·ªù duy·ªát' : 'ƒêang m∆∞·ª£n';
            
            return `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.borrowDate}</td>
                    <td>${item.dueDate}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="extendBorrow(${idx})" style="background:#3498db; color:white; border:none; padding:0.5rem 1rem; border-radius:0.3rem; cursor:pointer; margin-right:0.5rem;">Gia H·∫°n</button>
                    </td>
                </tr>
            `;
        }).join('');
        empty.style.display = 'none';
    }
}

function loadFavorites() {
    const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
    const grid = document.getElementById('favoritesGrid');
    const empty = document.getElementById('favoritesEmpty');
    
    if (favorites.length === 0) {
        grid.innerHTML = '';
        empty.style.display = 'block';
    } else {
        grid.innerHTML = favorites.map(fav => `
            <div style="background:#f9f9f9; padding:1rem; border-radius:0.5rem; text-align:center;">
                <p style="font-weight:bold; margin:0 0 0.5rem 0;">${fav.name}</p>
                <a href="book-details.html?id=${fav.id}" class="btn" style="display:inline-block;">Xem Chi Ti·∫øt</a>
            </div>
        `).join('');
        empty.style.display = 'none';
    }
}

function extendBorrow(idx) {
    const cart = JSON.parse(localStorage.getItem('cart')) || [];
    const borrowing = cart.filter(item => item.status !== 'returned');
    const item = borrowing[idx];
    
    if (!item) return;
    
    const oldDueDate = new Date(item.dueDate);
    const newDueDate = new Date(oldDueDate);
    newDueDate.setDate(newDueDate.getDate() + 14); // Gia h·∫°n 14 ng√†y
    
    item.dueDate = newDueDate.toISOString().split('T')[0];
    
    // Update in cart
    const cartIdx = cart.findIndex(c => c.id === item.id && c.borrowDate === item.borrowDate);
    if (cartIdx !== -1) {
        cart[cartIdx].dueDate = item.dueDate;
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    loadBorrowingList();
    showNotification('‚úì Gia h·∫°n th√†nh c√¥ng! H·∫°n tr·∫£ m·ªõi: ' + item.dueDate);
}

function changePassword(event) {
    event.preventDefault();
    
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!');
        return;
    }
    
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    
    const userIdx = users.findIndex(u => u.email === currentUser.email && u.password === oldPassword);
    if (userIdx === -1) {
        alert('M·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng!');
        return;
    }
    
    users[userIdx].password = newPassword;
    localStorage.setItem('users', JSON.stringify(users));
    
    alert('‚úì ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
}

function switchSection(sectionId, element) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
    
    // Show selected section
    document.getElementById(sectionId).classList.add('active');
    element.classList.add('active');
    
    // Load data for section
    if (sectionId === 'borrowing') loadBorrowingList();
    if (sectionId === 'favorites') loadFavorites();
    if (sectionId === 'membership') loadMembershipTier();
}

function loadMembershipTier() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const tier = currentUser.membershipTier;
    
    // N·∫øu kh√¥ng c√≥ tier, ·∫©n heading
    if (!tier) {
        document.getElementById('currentTierName').innerHTML = '‚ùå Ch∆∞a ƒêƒÉng K√Ω';
    } else {
        document.getElementById('currentTierName').innerHTML = '‚úì ƒê√£ ƒêƒÉng K√Ω';
    }
    
    // Show current membership info
    const membershipInfo = document.getElementById('currentMembershipInfo');
    const membershipText = document.getElementById('currentMembershipText');
    const cancelBtn = document.getElementById('cancelTierBtn');
    const registerBtn = document.getElementById('tierBronzeBtn');
    
    if (tier) {
        membershipInfo.style.display = 'block';
        membershipText.textContent = 'üìñ G√≥i Ti√™u Chu·∫©n - 50,000‚Ç´/th√°ng';
        cancelBtn.style.display = 'inline-block';
        registerBtn.textContent = '‚úì ƒêang D√πng';
        registerBtn.disabled = true;
        registerBtn.style.opacity = '0.7';
    } else {
        membershipInfo.style.display = 'none';
        cancelBtn.style.display = 'none';
        registerBtn.textContent = 'ƒêƒÉng K√Ω';
        registerBtn.disabled = false;
        registerBtn.style.opacity = '1';
    }
}

function registerTier(newTier) {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const users = JSON.parse(localStorage.getItem('users'));
    
    if (confirm('B·∫°n c√≥ mu·ªën ƒëƒÉng k√Ω g√≥i Ti√™u Chu·∫©n (50,000‚Ç´/th√°ng)?')) {
        currentUser.membershipTier = 'bronze';
        currentUser.status = 'user';
        
        // Update in users array
        const userIdx = users.findIndex(u => u.email === currentUser.email);
        if (userIdx !== -1) {
            users[userIdx].membershipTier = 'bronze';
            users[userIdx].status = 'user';
        }
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('users', JSON.stringify(users));
        
        alert('‚úì ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n ƒë√£ c√≥ th·ªÉ m∆∞·ª£n s√°ch r·ªìi!');
        
        loadMembershipTier();
    }
}

function cancelTier() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    const users = JSON.parse(localStorage.getItem('users'));
    
    if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën hu·ª∑ g√≥i h·∫°ng? B·∫°n s·∫Ω kh√¥ng th·ªÉ m∆∞·ª£n s√°ch n·ªØa.')) {
        currentUser.membershipTier = null;
        currentUser.status = 'guest';  // Quay l·∫°i guest
        
        // Update in users array
        const userIdx = users.findIndex(u => u.email === currentUser.email);
        if (userIdx !== -1) {
            users[userIdx].membershipTier = null;
            users[userIdx].status = 'guest';
        }
        
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('users', JSON.stringify(users));
        
        alert('‚úì Hu·ª∑ g√≥i h·∫°ng th√†nh c√¥ng!');
        
        loadMembershipTier();
    }
}

function logout() {
    if (confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
    }
}
</script>
</body>
</html>
